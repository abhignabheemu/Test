//import EmailTestReport.SMTPAuthenticator;

import javax.activation.DataHandler;
import javax.activation.DataSource;
import javax.activation.FileDataSource;
import javax.mail.*;
import javax.mail.internet.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.*;


public class Sendmail {
	
	Properties props = new Properties();
	private String smtpHostName = null;
	private String recipient = null;
	private String subject = null;
	private String from = null;
	private String port = null;
	private String smtp = null;
	//private String Os=null;
	public String filepath = null;
	
	public Sendmail() throws IOException
	{
		//String ErrorMessage ="";
//		try {
//			
//			postMail("C:\\Resultpath\\FinalReport2012-04-04-07-20-23");
//			//postMail("C:\\Loaduiresults\\ServerVitals2012-04-04-06-15-521.csv");
//		} catch (MessagingException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		}
	}
		
	public void postMail(String Attachmentpath) throws MessagingException, IOException
	{
		boolean debug = false;
		
		Message msg;
		new ReadConfigDetails();
		String ErrorMessage = "passed";//LoadTestReport.finalTestResult;
		smtpHostName = ReadConfigDetails.SMTPServer;//"mx.valuelabs.net";
		
		recipient = Framework.recipents;//"abhigna.bheemu@valuelabs.net";
		System.out.println("Recpient " + recipient);
		System.out.println("Attachment path " + Attachmentpath);
		from = ReadConfigDetails.FromMailAddress;//"abhigna.bheemu@valuelabs.net";
		subject = "Testmail";
		smtp = ReadConfigDetails.SMTPServer;//"mx.valuelabs.net";
		port = ReadConfigDetails.SMTPPort;//"25";
		//Os= props.getProperty("OS");
		
		props.put("mail.smtp.host", smtpHostName);
		props.put("mail.smtp.auth", "true");
		Properties props = new Properties();
		props.setProperty("mail.transport.protocol", smtp);
		props.setProperty("mail.host", "mx.valuelabs.net");
		props.setProperty("mail.port", port);
		Authenticator auth = new SMTPAuthenticator();
		
		Session session = Session.getDefaultInstance(props, auth);
		session.setDebug(debug);
		
		// create a message
		msg = new MimeMessage(session);
		
		// set the from and to address
		InternetAddress addressFrom = new InternetAddress(from);
		msg.setFrom(addressFrom);
		String[] recipients = recipient.split(";");
		InternetAddress[] addressTo =new InternetAddress[recipients.length];
		for (int i = 0; i < recipients.length; i++)
		{
			addressTo[i] = new InternetAddress(recipients[i]);
		}
		msg.setRecipients(Message.RecipientType.TO, addressTo);
		// Setting the Subject and Content Type
		//int passedcnt=2;
		//int failedcnt=1;
		//int skippedcnt=0;
		//int totalcnt=passedcnt + failedcnt + skippedcnt;
		//subject=subject +" - "+ (new java.util.Date()).toString();
		if (ErrorMessage.equalsIgnoreCase("passed"))
		{
			subject="PerformanceReport - Passed - "+ (new java.util.Date()).toString();
		}
		else
		{
			subject="PerformanceReport - Failed - "+ (new java.util.Date()).toString();
		}
		//if(failedcnt >= 1) subject=subject + " -- Contains Failed Cases";
		msg.setSubject(subject);
		String message="<b>Hi All,</b><br>" + "Please find the performance statistics with attachment" + "</h3><br/>Thanks,<br/>Abhigna <br/><STYLE>BODY{color:#000001;font-size:10pt; font-family:TrebuchetMS }</STYLE><BODY>";//<br/><br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Please find the High-Level Automation Test summary for FamilyLink as follows: <br/> <ul><h3>FamilyLink Test summary for "+ Os + " :</h3><table border=3 cellpadding=5 ><tr><th align=left>Passed:</th><td align=center width=80 style=color:#149106 ><b>"+ passedcnt + "</b></td></tr><tr><th align=left >Failed:</th><td align=center width=80 style=color:red ><b>"+ failedcnt +"</b></td></tr><tr><th align=left >Skipped:</th><td align=center width=80 style=color:#0000FF ><b>" + skippedcnt + "</b></td></tr><tr><th align=left>Total Cases:</th><td align=center width =80 style=color:#000001><b>"+ totalcnt +"</b></td></tr></table></ul><br/>&nbsp;&nbsp;&nbsp;Please find Test Automation Report attached with this email.</br></br><b><p>Note:</b> This is an automated Email generated by Selenium. All failed cases would be re-executed manually to verify if they are really build error(s) and not Test Data/Script errors.<br/><br/>Thanks,<br/>Naresh Nayini<br/><STYLE>BODY{color:#000001;font-size:10pt; font-family:TrebuchetMS }</STYLE><BODY>";
		
		msg.setContent(message, "text/html");
		BodyPart messageBodyPart = new MimeBodyPart();
		messageBodyPart.setContent(message, "text/html");
		Multipart multipart = new MimeMultipart();
		multipart.addBodyPart(messageBodyPart);
		String AttachFiles= Attachmentpath+".html";//"D:\\websites.txt,c:\\loadui.txt";
		System.out.println("Attachment path " + AttachFiles);
		String testResultPath = "";
		String[]ArrAttFiles = null;
		
		ArrAttFiles = AttachFiles.split(",");
		System.out.println(ArrAttFiles.length);
		for(int k=0;k<=ArrAttFiles.length-1;k++ )
		{
			messageBodyPart = new MimeBodyPart();
			
			testResultPath = ArrAttFiles[k];
			System.out.println("test result path   " +testResultPath);
			DataSource tResult = new FileDataSource(ArrAttFiles[k]);
			messageBodyPart.setDataHandler(new DataHandler(tResult));
			messageBodyPart.setFileName(testResultPath.substring(testResultPath.lastIndexOf('/')+ 1, testResultPath.length()));
			multipart.addBodyPart(messageBodyPart);
		}
		
		//messageBodyPart = new MimeBodyPart();
		
		//testResultPath = ArrAttFiles[k];
//		System.out.println(AttachFiles);
//		DataSource tResult = new FileDataSource(AttachFiles);
//		messageBodyPart.setDataHandler(new DataHandler(tResult));
//		messageBodyPart.setFileName(AttachFiles.substring(AttachFiles.lastIndexOf('/')+ 1, AttachFiles.length()));
//		multipart.addBodyPart(messageBodyPart);
		
		msg.setContent(multipart);
		try{
			Transport.send(msg);
		}
		catch(SendFailedException sfe)
		{
			sfe.printStackTrace();
		} 
	} 
	
	/**
	* SimpleAuthenticator is used to do simple authentication
	* when the SMTP server requires it.
	*/
	private class SMTPAuthenticator extends javax.mail.Authenticator
	{
		private PasswordAuthentication authentication;

		public SMTPAuthenticator() {
			String username= "sravanthi.kotha@valuelabs.net";
			String password = "lakshmi@56";	
			authentication = new PasswordAuthentication(username, password);
		}

		protected PasswordAuthentication getPasswordAuthentication() {
			return authentication;
		}
	}

	public  void MoveFiles()throws InterruptedException
    {	
 
    	InputStream inStream = null;
    	OutputStream outStream = null;
 
    	try{
    		String filepaths = "";
    		File folder = new File("C:\\Loaduiresults");
    		File[] listOfFiles = folder.listFiles();
			
    		 for (int i = 0; i < listOfFiles.length; i++) 
    		 {
    			 File afile =new File("C:\\Loaduiresults\\"+listOfFiles[i].getName());
    			 File bfile =new File("c:\\LoadUIResultsTransfer\\"+afile.getName());
 
    			 inStream = new FileInputStream(afile);
    			 outStream = new FileOutputStream(bfile);
 
    			 byte[] buffer = new byte[1024];
 
    			 int length;
    	    //copy the file content in bytes 
    			 while ((length = inStream.read(buffer)) > 0)
    			 {
 
    				 outStream.write(buffer, 0, length);
    			 }
 
	    	    inStream.close();
	    	    Thread.sleep(500);
	    	    outStream.close();
	    	    Thread.sleep(500);
	    	    //delete the original file
	    	    filepath = filepath + afile.getName() +",";	     	    
	    	    afile.delete();
	    	    
	 
	    	    System.out.println("File is copied successful!");
    		 }
 
    	}
    	catch(IOException e){
    	    e.printStackTrace();
    	}
    }
	
	

//	public static void main(String args[])
//	{
//			
//		try {
//			new Sendmail();
//		} catch (IOException e) {
//			// TODO Auto-generated catch block
//			e.printStackTrace();
//		}
//	}
}


